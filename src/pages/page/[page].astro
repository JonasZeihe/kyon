---
import HomeLayout from '../../layouts/HomeLayout.astro'
import PostCard from '../../components/feed/PostCard.astro'
import Pagination from '../../components/feed/Pagination.astro'
import { getAllPosts } from '../../lib/content'

const POSTS_PER_PAGE = 8

export async function getStaticPaths() {
  const posts = await getAllPosts()
  const totalPages = Math.max(1, Math.ceil(posts.length / POSTS_PER_PAGE))
  return Array.from({ length: totalPages }, (_, i) => ({
    params: { page: String(i + 1) },
  }))
}

const { page } = Astro.params
const pageNum = Number(page) || 1

const posts = await getAllPosts()
const totalPages = Math.max(1, Math.ceil(posts.length / POSTS_PER_PAGE))
if (pageNum < 1 || pageNum > totalPages)
  throw new Error(`Page ${pageNum} not found`)

const start = (pageNum - 1) * POSTS_PER_PAGE
const pagePosts = posts.slice(start, start + POSTS_PER_PAGE)
const BASE = (import.meta.env.BASE_URL || '/').replace(/\/+$/, '/')
---

<HomeLayout title={`Kyon â€” Seite ${pageNum}`} intro="">
  {pagePosts.map((p) => <PostCard post={p} />)}
  <Fragment slot="pagination">
    <Pagination page={pageNum} pages={totalPages} base={`${BASE}page`} />
  </Fragment>
</HomeLayout>
