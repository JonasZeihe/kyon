---
import PostLayout from '../../layouts/PostLayout.astro'
import PostMeta from '../../components/post/PostMeta.astro'
import PostHero from '../../components/post/PostHero.astro'
import PostNav from '../../components/post/PostNav.astro'
import {
  getAllPosts,
  getPostBySlug,
  getPostModuleBySlug,
} from '../../lib/content'

export async function getStaticPaths() {
  const posts = await getAllPosts()
  return posts.map((p) => ({ params: { slug: p.slug } }))
}

const { slug } = Astro.params
if (!slug) throw new Error('Missing slug')

const entry = await getPostBySlug(slug)
if (!entry) throw new Error(`Post not found: ${slug}`)

const mod = getPostModuleBySlug(slug)
const Content = mod?.Content

const posts = await getAllPosts()
const idx = posts.findIndex((p) => p.slug === slug)
const prev =
  idx > 0
    ? { slug: posts[idx - 1].slug, title: posts[idx - 1].title }
    : undefined
const next =
  idx < posts.length - 1
    ? { slug: posts[idx + 1].slug, title: posts[idx + 1].title }
    : undefined
---

<PostLayout title={entry.title} description={entry.description}>
  <Fragment slot="meta"><PostMeta entry={entry} /></Fragment>
  <PostHero slot="hero" hero={entry.image} />
  <Fragment>{Content ? <Content /> : null}</Fragment>
  <PostNav slot="nav" prev={prev} next={next} />
</PostLayout>
